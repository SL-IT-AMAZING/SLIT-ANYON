# Deployment Guide

This guide enables any team member to execute a release of the Anyon Electron app independently.

## Prerequisites

### Required Accounts

- **Apple Developer Account** - For macOS code signing and notarization
- **Azure Account** - For Windows Trusted Signing (Azure Code Signing service)
- **GitHub Account** - With write access to the `anyon-sh/anyon` repository

### Required Tools

- **Node.js 20** or higher (check: `node --version`)
- **npm** (comes with Node.js)
- **git** (check: `git --version`)

### Required Environment Variables

All environment variables must be configured as GitHub repository secrets in the `release` environment.

#### macOS Signing

| Variable              | Description                     | How to Obtain                                                                                      |
| --------------------- | ------------------------------- | -------------------------------------------------------------------------------------------------- | ------- |
| `APPLE_ID`            | Apple ID email address          | Your Apple Developer account email                                                                 |
| `APPLE_PASSWORD`      | App-specific password           | Generate at [appleid.apple.com](https://appleid.apple.com) â†’ Security â†’ App-Specific Passwords     |
| `APPLE_TEAM_ID`       | Apple Developer Team ID         | Find in Apple Developer account â†’ Membership details                                               |
| `MACOS_CERT_P12`      | Base64-encoded .p12 certificate | Export Developer ID Application certificate from Keychain Access, then: `base64 -i certificate.p12 | pbcopy` |
| `MACOS_CERT_PASSWORD` | Password for .p12 certificate   | Password you set when exporting the certificate                                                    |

#### Windows Signing

| Variable                  | Description                       | How to Obtain                                                                            |
| ------------------------- | --------------------------------- | ---------------------------------------------------------------------------------------- |
| `AZURE_CLIENT_ID`         | Azure service principal client ID | Azure Portal â†’ App registrations â†’ Your app â†’ Application (client) ID                    |
| `AZURE_CLIENT_SECRET`     | Azure service principal secret    | Azure Portal â†’ App registrations â†’ Your app â†’ Certificates & secrets â†’ New client secret |
| `AZURE_TENANT_ID`         | Azure tenant ID                   | Azure Portal â†’ Azure Active Directory â†’ Overview â†’ Tenant ID                             |
| `AZURE_CODE_SIGNING_DLIB` | Path to Azure Code Signing DLL    | Auto-detected by workflow (installed via winget)                                         |
| `AZURE_METADATA_JSON`     | Path to signing metadata JSON     | Auto-generated by workflow                                                               |
| `SIGNTOOL_PATH`           | Path to Windows SDK signtool.exe  | Auto-detected by workflow                                                                |

#### GitHub

| Variable       | Description                 | How to Obtain                                     |
| -------------- | --------------------------- | ------------------------------------------------- |
| `GITHUB_TOKEN` | GitHub authentication token | Auto-provided by GitHub Actions (no setup needed) |

#### AI Providers (Optional - for local development only)

| Variable            | Description       | How to Obtain                                                                      |
| ------------------- | ----------------- | ---------------------------------------------------------------------------------- |
| `OPENAI_API_KEY`    | OpenAI API key    | [platform.openai.com/api-keys](https://platform.openai.com/api-keys)               |
| `ANTHROPIC_API_KEY` | Anthropic API key | [console.anthropic.com/settings/keys](https://console.anthropic.com/settings/keys) |
| `GOOGLE_API_KEY`    | Google AI API key | [aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)           |

## Pre-Release Checklist

### 1. Version Bump

Update the version in `package.json`:

```bash
# For a patch release (0.36.0 -> 0.36.1)
npm version patch

# For a minor release (0.36.0 -> 0.37.0)
npm version minor

# For a major release (0.36.0 -> 1.0.0)
npm version major

# Or manually edit package.json and set the version
```

### 2. Update CHANGELOG

Add release notes to `CHANGELOG.md` (if it exists) or prepare release notes for GitHub:

- List new features
- List bug fixes
- List breaking changes (if any)
- Credit contributors

### 3. Test Requirements

Run all tests before releasing:

```bash
# Unit tests
npm test

# Type checking
npm run ts

# Linting
npm run lint

# Build verification (creates production build)
npm run make
```

### 4. Manual Smoke Testing

After running `npm run make`, test the built application on each platform:

- **macOS**: Test `.app` in `out/anyon-darwin-arm64/` or `out/anyon-darwin-x64/`
- **Windows**: Test `.exe` installer in `out/make/squirrel.windows/x64/`
- **Linux**: Test `.deb`, `.rpm`, or `.AppImage` in `out/make/`

Verify:

- Application launches successfully
- Core features work (create app, chat, settings)
- No console errors
- Database migrations apply correctly

### 5. Commit and Push

```bash
git add package.json package-lock.json
git commit -m "chore: bump version to vX.Y.Z"
git push origin main
```

## Release Process (Step-by-Step)

### Step 1: Ensure CI Passes on Main

Check that all CI checks pass on the `main` branch:

```bash
# View recent commits and their status
git log --oneline -5

# Or check GitHub Actions directly
open https://github.com/SL-IT-AMAZING/SLIT-ANYON/actions
```

### Step 2: Create Git Tag

Create a tag matching the version in `package.json`:

```bash
# If package.json shows "version": "0.36.0"
git tag v0.36.0

# For beta releases
git tag v0.36.0-beta.1
```

### Step 3: Push Tag

Push the tag to trigger the release workflow:

```bash
git push origin v0.36.0

# Or for beta
git push origin v0.36.0-beta.1
```

### Step 4: Monitor GitHub Actions Release Workflow

The release workflow will automatically start when the tag is pushed.

1. Go to: https://github.com/SL-IT-AMAZING/SLIT-ANYON/actions
2. Click on the "Release app" workflow run
3. Monitor the 4 parallel build jobs:
   - `windows-latest` - Windows .exe installer and .nupkg
   - `ubuntu-22.04` - Linux .deb, .rpm, and .AppImage
   - `macos-15-intel` - macOS Intel (x64) .zip
   - `macos-latest` - macOS Apple Silicon (arm64) .zip

**Expected duration**: 20-30 minutes per platform (with 3 retry attempts)

**Timeout**: 30 minutes per attempt (90 minutes max with retries)

### Step 5: Verify Assets

After all build jobs complete, verify all expected assets are uploaded:

```bash
# Set your GitHub token
export GITHUB_TOKEN=your_github_token_here

# Run verification script
npm run verify-release
```

Expected output:

```
âœ… VERIFICATION PASSED!
ðŸŽ‰ All 8 expected assets are present in release vX.Y.Z
```

### Step 6: Edit Draft Release on GitHub

1. Go to: https://github.com/SL-IT-AMAZING/SLIT-ANYON/releases
2. Find the draft release (marked with "Draft" badge)
3. Click "Edit"
4. Add release notes:
   - Summary of changes
   - New features
   - Bug fixes
   - Breaking changes (if any)
   - Known issues (if any)
5. Click "Save draft"

### Step 7: Publish Release

1. Uncheck "Set as a pre-release" (unless this is a beta release)
2. Check "Set as the latest release"
3. Click "Publish release"

**The release is now live!** Users will receive auto-updates within 24 hours.

## Environment Variables Reference

### Complete List

| Variable                  | Required For                 | Description                | How to Obtain                              |
| ------------------------- | ---------------------------- | -------------------------- | ------------------------------------------ |
| `APPLE_ID`                | macOS notarization           | Apple ID email             | Apple Developer account email              |
| `APPLE_PASSWORD`          | macOS notarization           | App-specific password      | Generate at appleid.apple.com              |
| `APPLE_TEAM_ID`           | macOS signing & notarization | Developer Team ID          | Apple Developer Membership details         |
| `MACOS_CERT_P12`          | macOS signing                | Base64-encoded certificate | Export from Keychain, encode with `base64` |
| `MACOS_CERT_PASSWORD`     | macOS signing                | Certificate password       | Password set during export                 |
| `AZURE_CLIENT_ID`         | Windows signing              | Service principal ID       | Azure Portal â†’ App registrations           |
| `AZURE_CLIENT_SECRET`     | Windows signing              | Service principal secret   | Azure Portal â†’ Certificates & secrets      |
| `AZURE_TENANT_ID`         | Windows signing              | Azure tenant ID            | Azure Portal â†’ Azure AD â†’ Overview         |
| `AZURE_CODE_SIGNING_DLIB` | Windows signing              | Path to signing DLL        | Auto-detected by workflow                  |
| `AZURE_METADATA_JSON`     | Windows signing              | Signing metadata file      | Auto-generated by workflow                 |
| `SIGNTOOL_PATH`           | Windows signing              | Path to signtool.exe       | Auto-detected by workflow                  |
| `GITHUB_TOKEN`            | Publishing                   | GitHub API token           | Auto-provided by Actions                   |

## Code Signing

### Linux (Optional)

Linux packages can optionally be GPG-signed for package manager trust.

#### Setup

1. Generate GPG key: `gpg --full-generate-key` (RSA 4096, no expiration)
2. Export private key: `gpg --armor --export-secret-keys <email> | base64 | pbcopy`
3. Add `GPG_PRIVATE_KEY` to GitHub repository secrets (paste the base64-encoded key)
4. Add `GPG_KEY_ID` to GitHub repository secrets (your GPG key ID, e.g., `1A2B3C4D`)
5. Add `GPG_PASSPHRASE` to GitHub repository secrets (if key has passphrase)

#### Verification

- DEB: `dpkg-sig --verify <file>.deb`
- RPM: `rpm --checksig <file>.rpm`

#### How It Works

The release workflow will:

1. Check if `GPG_PRIVATE_KEY` secret is configured
2. Import the GPG key into the build environment
3. Sign `.deb` packages with `dpkg-sig`
4. Sign `.rpm` packages with `rpm --addsign`
5. Continue gracefully if signing fails (non-blocking)

### macOS

#### Certificate Setup

The workflow uses `tools/add-macos-cert.sh` to set up the signing certificate:

1. Creates a temporary keychain (`build.keychain`)
2. Decodes the base64-encoded certificate from `MACOS_CERT_P12`
3. Imports the certificate with password from `MACOS_CERT_PASSWORD`
4. Downloads and trusts Apple's Developer ID Intermediate Certificate
5. Configures the keychain for codesign access

#### Notarization Requirements

Notarization is handled by `@electron/packager` with these environment variables:

- `APPLE_ID` - Apple ID email address
- `APPLE_PASSWORD` - App-specific password (NOT your Apple ID password)
- `APPLE_TEAM_ID` - 10-character team identifier

**Configuration in `forge.config.ts`:**

```typescript
osxSign: {
  identity: process.env.APPLE_TEAM_ID,
},
osxNotarize: {
  appleId: process.env.APPLE_ID!,
  appleIdPassword: process.env.APPLE_PASSWORD!,
  teamId: process.env.APPLE_TEAM_ID!,
}
```

#### Troubleshooting

**"App is damaged and can't be opened" error:**

- Cause: Notarization failed or certificate expired
- Solution: Check workflow logs for notarization errors
- Verify certificate is valid: `security find-identity -v -p codesigning`

**Notarization timeout:**

- Cause: Apple's notarization service is slow
- Solution: Increase workflow timeout in `.github/workflows/release.yml`:
  ```yaml
  timeout_minutes: 45 # Increase from 30
  ```

**Certificate expired:**

- Renew certificate in Apple Developer portal
- Export new certificate from Keychain Access
- Update `MACOS_CERT_P12` and `MACOS_CERT_PASSWORD` secrets

### Windows

#### Azure Trusted Signing Setup

The workflow installs Azure Trusted Signing tools via winget:

```powershell
winget install -e --id Microsoft.Azure.TrustedSigningClientTools
```

Then locates the signing DLL (`Azure.CodeSigning.Dlib.dll`) and signtool.exe.

#### Required Environment Variables

- `AZURE_CLIENT_ID` - Service principal client ID
- `AZURE_CLIENT_SECRET` - Service principal secret
- `AZURE_TENANT_ID` - Azure tenant ID
- `AZURE_CODE_SIGNING_DLIB` - Path to `Azure.CodeSigning.Dlib.dll` (auto-detected)
- `AZURE_METADATA_JSON` - Path to signing metadata JSON (auto-generated)
- `SIGNTOOL_PATH` - Path to `signtool.exe` (auto-detected)

#### Signing Metadata

The workflow generates `signing-metadata.json`:

```json
{
  "Endpoint": "https://eus.codesigning.azure.net/",
  "CodeSigningAccountName": "anyon",
  "CertificateProfileName": "anyon-tech"
}
```

#### Configuration in `windowsSign.ts`

```typescript
export const windowsSign: WindowsSignOptions = {
  signToolPath: process.env.SIGNTOOL_PATH,
  signWithParams: `/v /debug /dlib ${process.env.AZURE_CODE_SIGNING_DLIB} /dmdf ${process.env.AZURE_METADATA_JSON}`,
  timestampServer: "http://timestamp.acs.microsoft.com",
  hashes: ["sha256"],
};
```

#### Troubleshooting

**"Azure.CodeSigning.Dlib.dll not found" error:**

- Cause: winget installation failed or DLL not in expected location
- Solution: Check workflow logs for winget installation errors
- Verify DLL exists in workflow output

**SmartScreen warnings:**

- Cause: New certificate or low download count
- Solution: This is expected for new releases. Users can click "More info" â†’ "Run anyway"
- SmartScreen reputation builds over time with more downloads

**"The specified timestamp server could not be reached" error:**

- Cause: Microsoft's timestamp server is temporarily unavailable
- Solution: Workflow will retry up to 3 times automatically
- If persistent, check Microsoft's service status

## Auto-Update System

### How It Works

Anyon uses `update-electron-app` to check for updates:

1. App checks for updates on launch and every 10 minutes
2. Queries `https://api.anyon.sh/update` (or GitHub Releases API)
3. Downloads and installs updates in the background
4. Prompts user to restart when update is ready

**Configuration in `src/main.ts`:**

```typescript
import { updateElectronApp } from "update-electron-app";

updateElectronApp({
  updateInterval: "10 minutes",
  logger: log,
});
```

### Stable vs Beta Channels

- **Stable**: Releases without "beta" in version (e.g., `v0.36.0`)
- **Beta**: Releases with "beta" in version (e.g., `v0.36.0-beta.1`)

Users on stable channel will NOT receive beta updates automatically.

### Beta â†’ Stable Transition

When promoting a beta release to stable (e.g., 0.36.0-beta.1 â†’ 0.36.0):

1. **Both channels receive the same build**: The stable release (v0.36.0) is published as a non-prerelease GitHub Release. The update server at `api.anyon.sh` serves the latest non-prerelease version for the `stable` channel and the latest (including prerelease) for the `beta` channel.

2. **Beta users auto-upgrade**: Since 0.36.0 > 0.36.0-beta.1, beta channel users will automatically receive the stable release.

3. **No manual intervention needed**: The `update-electron-app` library handles semver comparison automatically.

4. **Future beta releases**: To resume beta testing, publish a new prerelease (e.g., v0.37.0-beta.1). Only beta channel users will receive it.

**Release channel configuration in `src/main.ts`:**

```typescript
const postfix = settings.releaseChannel === "beta" ? "beta" : "stable";
const host = `https://api.anyon.sh/v1/update/${postfix}`;
```

Users can switch channels in Settings > General > Release Channel.

### Update Check Interval

- **On launch**: Immediate check
- **Background**: Every 10 minutes
- **User-triggered**: Via "Check for Updates" in app menu (if implemented)

### Staged Rollout

Updates can be rolled out gradually using a server-side percentage gate combined with deterministic client-side bucketing.

#### Bucket System

Each machine is assigned a stable bucket (0â€“99) derived from an MD5 hash of `app.getPath('userData')`. The same machine always maps to the same bucket across restarts, so a user won't flip between "included" and "excluded" during a rollout.

#### Server-Side Gating

The endpoint `https://api.anyon.sh/v1/update/rollout-config.json` controls rollout:

```json
{
  "version": "0.36.0",
  "rolloutPercentage": 25
}
```

When `rolloutPercentage` is 25, only users in buckets 0â€“24 are served the update. The config gates a specific version â€” unrecognized versions pass through ungated.

The system is **fail-open**: if the config endpoint is unreachable, returns an error, or has a malformed response, updates proceed at 100%.

#### Manual Staged Rollout

To perform a staged rollout, update `rollout-config.json` on `api.anyon.sh` with the target version and desired percentage.

**Example schedule:**

| Day | `rolloutPercentage` | Coverage                     |
| --- | ------------------- | ---------------------------- |
| 1   | 10                  | ~10% of users (buckets 0â€“9)  |
| 3   | 25                  | ~25% of users (buckets 0â€“24) |
| 5   | 50                  | ~50% of users (buckets 0â€“49) |
| 7   | 100                 | All users                    |

To halt a rollout, set `rolloutPercentage` to `0`. Users who already downloaded the update keep it.

To skip gating entirely (immediate full rollout), set `rolloutPercentage` to `100` or remove the config file.

#### Key Files

| File                 | Purpose                                            |
| -------------------- | -------------------------------------------------- |
| `src/lib/rollout.ts` | `getUserRolloutBucket()` and `shouldApplyUpdate()` |
| `src/main.ts`        | Logs rollout bucket at startup for observability   |

## Rollback Procedures

### Scenario 1: Critical Bug Found (< 24h after release)

**Symptoms**: P0 bug reported, app crashes on launch, data loss

**Steps**:

1. **Unpublish GitHub Release** (stops new downloads):

   ```bash
   # Via GitHub CLI
   gh release delete vX.Y.Z --yes

   # Or via web UI
   # Go to: https://github.com/SL-IT-AMAZING/SLIT-ANYON/releases
   # Click release â†’ Delete
   ```

2. **Users on old version won't auto-update** to the broken version

3. **Publish hotfix** (vX.Y.1):

   ```bash
   # Fix the bug in code
   npm version patch  # Bumps to vX.Y.1
   git add package.json package-lock.json
   git commit -m "fix: critical bug in feature X"
   git push origin main

   # Create and push tag
   git tag vX.Y.1
   git push origin vX.Y.1

   # Follow normal release process
   ```

**Recovery Time**: 30-60 minutes (fix + build + publish)

### Scenario 2: Database Migration Failure

**Symptoms**: App fails to start after update, "database error" messages

**SQLite Database Location**:

- **macOS**: `~/Library/Application Support/anyon/`
- **Windows**: `%APPDATA%\anyon\`
- **Linux**: `~/.config/anyon/`

**Manual Recovery Steps**:

1. **Backup user's database**:

   ```bash
   # macOS
   cp ~/Library/Application\ Support/anyon/anyon.db ~/Desktop/anyon-backup.db

   # Windows
   copy %APPDATA%\anyon\anyon.db %USERPROFILE%\Desktop\anyon-backup.db

   # Linux
   cp ~/.config/anyon/anyon.db ~/Desktop/anyon-backup.db
   ```

2. **Rollback to previous version**:
   - Download previous release from GitHub Releases
   - Install over current version
   - App will use backed-up database

3. **Drizzle Migration Rollback**:
   - Migrations are in `drizzle/` directory
   - Each migration has a corresponding `.sql` file
   - To rollback, manually execute reverse SQL statements
   - **Note**: Drizzle doesn't have built-in rollback - design migrations carefully!

**Prevention**:

- Test migrations thoroughly before release
- Include migration tests in E2E test suite
- Consider adding migration rollback scripts for critical changes

### Scenario 3: Widespread Crashes (>1% crash rate)

**Symptoms**: Multiple crash reports, Sentry alerts (once integrated)

**Detection**:

- GitHub Issues with "crash" or "error" labels
- Sentry dashboard (once integrated) showing spike in errors
- User reports in GitHub Discussions

**Emergency Response**:

1. **Stop distribution immediately**:

   ```bash
   # Delete release assets to stop auto-update
   gh release delete-asset vX.Y.Z <asset-name>

   # Or delete entire release
   gh release delete vX.Y.Z --yes
   ```

2. **Investigate crash reports**:
   - Check GitHub Issues for stack traces
   - Review Sentry dashboard (once integrated)
   - Reproduce locally if possible

3. **Communication**:
   - Post to GitHub Discussions: "Known Issue: vX.Y.Z crashes on [condition]"
   - Pin the discussion
   - Provide workaround if available
   - Commit to timeline for fix

**Communication Template**:

```markdown
## Known Issue: vX.Y.Z Crashes on [Condition]

We've identified a critical issue in version X.Y.Z that causes crashes when [condition].

**Affected versions**: vX.Y.Z

**Workaround**: [If available]

**Status**: We're working on a hotfix and expect to release vX.Y.1 within [timeframe].

**What we're doing**:

- [ ] Root cause identified
- [ ] Fix implemented
- [ ] Testing in progress
- [ ] Hotfix release

We apologize for the inconvenience. If you're affected, please [workaround or rollback instructions].
```

### Recovery Time Objectives

| Phase                      | Target       | Actions                                         |
| -------------------------- | ------------ | ----------------------------------------------- |
| **Detection**              | < 1 hour     | Monitor GitHub Issues, Sentry (once integrated) |
| **Decision**               | < 30 minutes | Assess severity, decide on rollback vs. hotfix  |
| **Execution**              | < 15 minutes | Delete release, publish communication           |
| **User Impact Resolution** | < 24 hours   | Hotfix released, auto-update cycle completes    |

## Release Assets (Expected)

The release should include exactly **10 assets**:

| Asset                 | Platform      | Format      | Example Filename                |
| --------------------- | ------------- | ----------- | ------------------------------- |
| Windows Installer     | Windows       | `.exe`      | `anyon-0.36.0.Setup.exe`        |
| Windows NuGet Package | Windows       | `.nupkg`    | `anyon-0.36.0-full.nupkg`       |
| Windows RELEASES File | Windows       | `RELEASES`  | `RELEASES`                      |
| macOS DMG (ARM)       | macOS (arm64) | `.dmg`      | `anyon-0.36.0-arm64.dmg`        |
| macOS DMG (Intel)     | macOS (x64)   | `.dmg`      | `anyon-0.36.0-x64.dmg`          |
| macOS ZIP (ARM)       | macOS (arm64) | `.zip`      | `anyon-darwin-arm64-0.36.0.zip` |
| macOS ZIP (Intel)     | macOS (x64)   | `.zip`      | `anyon-darwin-x64-0.36.0.zip`   |
| Linux Debian          | Linux         | `.deb`      | `anyon_0.36.0_amd64.deb`        |
| Linux RPM             | Linux         | `.rpm`      | `anyon-0.36.0-1.x86_64.rpm`     |
| Linux AppImage        | Linux         | `.AppImage` | `anyon_0.36.0_x86_64.AppImage`  |

**Beta Release Naming**:

For beta releases (e.g., `v0.36.0-beta.1`), filenames vary by platform:

- **Windows installer**: `anyon-0.36.0-beta.1.Setup.exe` (keeps `-beta.1`)
- **Windows NuGet**: `anyon-0.36.0-beta1-full.nupkg` (removes dot: `-beta1`)
- **macOS**: `anyon-darwin-arm64-0.36.0-beta.1.zip` (keeps `-beta.1`)
- **Linux Debian**: `anyon_0.36.0.beta.1_amd64.deb` (replaces dash with dot: `.beta.1`)
- **Linux RPM**: `anyon-0.36.0.beta.1-1.x86_64.rpm` (replaces dash with dot: `.beta.1`)
- **Linux AppImage**: `anyon_0.36.0-beta.1_x86_64.AppImage` (keeps `-beta.1`)

## Troubleshooting

### macOS Notarization Timeout

**Symptom**: Workflow times out during "Publish app" step on macOS

**Cause**: Apple's notarization service is slow (can take 10-30 minutes)

**Solution**:

1. Increase workflow timeout in `.github/workflows/release.yml`:

   ```yaml
   - name: Publish app
     uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08
     with:
       timeout_minutes: 45 # Increase from 30
       max_attempts: 3
   ```

2. Check notarization status manually:
   ```bash
   xcrun notarytool history --apple-id "$APPLE_ID" --password "$APPLE_PASSWORD" --team-id "$APPLE_TEAM_ID"
   ```

### Windows Azure Signing DLL Not Found

**Symptom**: Build fails with "Could not find Azure.CodeSigning.Dlib.dll"

**Cause**: winget installation failed or DLL in unexpected location

**Solution**:

1. Check workflow logs for winget installation errors
2. Verify DLL search paths in workflow output
3. If persistent, manually specify DLL path in workflow:
   ```yaml
   - name: Set DLL path manually
     run: echo "AZURE_CODE_SIGNING_DLIB=C:\Path\To\Azure.CodeSigning.Dlib.dll" >> $GITHUB_ENV
   ```

### Linux Build Failures

**Symptom**: Build fails on `ubuntu-22.04` with native module errors

**Cause**: Native module (e.g., `better-sqlite3`) incompatible with Linux

**Solution**:

1. Check `forge.config.ts` â†’ `rebuildConfig`:

   ```typescript
   rebuildConfig: {
     extraModules: ["better-sqlite3"],
     force: true,
   }
   ```

2. Verify native modules are listed in `extraResource`:

   ```typescript
   extraResource: ["node_modules/dugite/git", "node_modules/@vscode"];
   ```

3. If persistent, rebuild native modules locally on Linux:
   ```bash
   npm rebuild better-sqlite3 --build-from-source
   ```

### Certificate Expiration

**Symptom**: Signing fails with "certificate expired" error

**macOS Certificate Renewal**:

1. Go to [Apple Developer portal](https://developer.apple.com/account/resources/certificates)
2. Revoke old certificate
3. Create new "Developer ID Application" certificate
4. Download and install in Keychain Access
5. Export as `.p12` with password
6. Update GitHub secrets:

   ```bash
   # Encode certificate
   base64 -i certificate.p12 | pbcopy

   # Update MACOS_CERT_P12 secret in GitHub
   # Update MACOS_CERT_PASSWORD secret in GitHub
   ```

**Windows Certificate Renewal**:

- Azure Trusted Signing certificates are managed by Azure
- Verify certificate profile is active in Azure Portal
- Check expiration date in Azure Portal â†’ Trusted Signing â†’ Certificate profiles

### Build Fails with "Out of Memory"

**Symptom**: Build fails with "JavaScript heap out of memory"

**Solution**: Increase Node.js memory limit (already configured in workflow):

```yaml
env:
  NODE_OPTIONS: "--max-old-space-size=4096"
```

If still failing, increase to `8192` or `16384`.

## Post-Release Monitoring

### GitHub Issues

Monitor for P0/P1 bug reports:

1. Go to: https://github.com/SL-IT-AMAZING/SLIT-ANYON/issues
2. Filter by labels: `bug`, `P0`, `P1`
3. Respond within 24 hours
4. Escalate critical issues immediately

### Analytics

Track adoption and usage via PostHog dashboard:

- **Adoption rate**: % of users on latest version
- **Update success rate**: % of successful auto-updates
- **Feature usage**: Track new feature adoption

**PostHog Dashboard**: https://us.posthog.com/ (project: Anyon)

### Crash Reporting

Monitor crash rates via Sentry dashboard (once integrated):

- **Crash rate**: % of sessions with crashes
- **Error rate**: % of sessions with errors
- **Top errors**: Most frequent error messages

**Sentry Dashboard**: Configure at https://sentry.io/ after setting `SENTRY_DSN`

### Auto-Update Metrics

Track auto-update performance:

- **Update check success rate**: % of successful update checks
- **Download success rate**: % of successful update downloads
- **Install success rate**: % of successful update installs

**Note**: These metrics require instrumentation (not yet implemented).

---

## Quick Reference

### Common Commands

```bash
# Version bump
npm version patch|minor|major

# Build verification
npm run make

# Run tests
npm test
npm run ts
npm run lint

# Create and push tag
git tag vX.Y.Z
git push origin vX.Y.Z

# Verify release assets
npm run verify-release

# Delete release (rollback)
gh release delete vX.Y.Z --yes
```

### Key Files

- `package.json` - Version number
- `forge.config.ts` - Build configuration
- `.github/workflows/release.yml` - Release workflow
- `windowsSign.ts` - Windows signing configuration
- `tools/add-macos-cert.sh` - macOS certificate setup
- `scripts/verify-release-assets.js` - Asset verification

### Key URLs

- **Releases**: https://github.com/SL-IT-AMAZING/SLIT-ANYON/releases
- **Actions**: https://github.com/SL-IT-AMAZING/SLIT-ANYON/actions
- **Issues**: https://github.com/SL-IT-AMAZING/SLIT-ANYON/issues
- **Discussions**: https://github.com/SL-IT-AMAZING/SLIT-ANYON/discussions

---

**Last Updated**: 2026-02-07
